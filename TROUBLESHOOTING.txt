Troubleshooting Guide for GCF and Omni
======================================

Note: This document contains some out-of-date output samples. More
up-to-date documentation is on the GCF and Omni Wiki.
See for example:
http://trac.gpolab.bbn.com/gcf/wiki/OmniTroubleShoot

Issues and sample from Omni/GCF ~ V1.1:

1) Slice URNs and CH URNs and AM URNs need to match each other and the 
appropriate credentials.

All the URNs that come out of a Control Framework have a common root 
(eg openflow:stanford) and all URNs need to be unique (geni.net:gpo and 
geni.net:gpo2 for my 2 parallel instances).
With the sample clearinghouse, the gcf_config file settings base_name and 
the Aggregate Manager 'name' will ensure that the reference
CH and AM will use matching URNs.
Through Omni, you can provide just a slice name and Omni will
construct the appropriate full URN.
If you use other tools or supply a full URN to Omni, this may 
be an issue.

And then of course use the right certificates for each Clearinghouse 
and Aggregate Manager.

If your CH cert is for openflow:stanford:authority+ch
Then your slices should be named
openflow:stanford:slice+<slice name>

You may get multiple kinds of errors when these don't match.

Often it's a cryptic SSL doHandshake error. Sometimes it looks like 
an error about Credential Verification.

EG when the MyPLC doesn't have the right trusted certificate:
>  ERROR:omni:Failed to List Resources from
>  urn:publicid:IDN+plc:gpo1+authority+sa
>  (http://myplc1.gpolab.bbn.com:12348): <Fault 108: ": ListResources:
>  Insufficient rights: Access denied: <class
>  'sfa.util.faults.CredentialNotVerifiable'> -- 'xmlsec1 error:
>
func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=360:obj=x509-store:subj=X509_verify_cert:error=4:crypto
>  library function
>  failed:subj=/CN=geni.net:gpo2:gcf+authority+ch;err=7;msg=certificate
>  signature
>
failure\\nfunc=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=408:obj=x509-store:subj=unknown:error=71:certificate
>  verification failed:err=7;msg=certificate signature
>  failure\\nOK\\nSignedInfo References (ok/all): 1/1\\nManifests
>  References (ok/all): 0/0\\n'">

When the slice name is wrong:
>  ERROR:omni:Failed to List Resources from
>  urn:publicid:IDN+geni.net:gpo3+authority+gcf (https://127.0.0.1:8005):
>  <Fault Insufficient privileges: "No credential was found with
>  appropriate privileges. Tried
>  urn:publicid:IDN+geni.net:gpo3:gcf+user+Aaron2. Last failure: Couldn't
>  validate cert urn:publicid:IDN+geni.net:gpo3:gcf+user+Aaron2 with known
>  root certs: 'This cert geni.net.gpo.gcf.foo3 HRN doesnt start with
>  parent HRN geni.net.gpo3.gcf'">

And failing to get the constants right can look like this:
>  INFO:cred-verifier:Couldn't validate cert
>  urn:publicid:IDN+geni.net:gpo2:gcf+user+Aaron with known root certs:
>  'This cert geni.net.gpo.gcf.c4f3-7cc.127.0.0.1%3A8002 HRN doesnt start
>  with parent HRN geni.net.gpo2.gcf'
>  ERROR:cred-verifier:No credential was found with appropriate privileges.
>  Tried urn:publicid:IDN+geni.net:gpo2:gcf+user+Aaron. Last failure:
>  Couldn't validate cert urn:publicid:IDN+geni.net:gpo2:gcf+user+Aaron
>  with known root certs: 'This cert
>  geni.net.gpo.gcf.c4f3-7cc.127.0.0.1%3A8002 HRN doesnt start with parent
>  HRN geni.net.gpo2.gcf'



2) Many errors are AM Server errors: If you see:
'Unable to allocate from:'
This is an error from your Aggregate Manager (eg gcf-am). Check the logs there.

3) SSL Errors are common: If you get this:

[root@localhost src]# python ./omni.py listresources
INFO:omni:Using control framework gcf
Traceback (most recent call last):
  File "./omni.py", line 354, in <module>
...
Exception: Using GCF Failed to do CH.CreateUserCredentials on CH
https://localhost:8000 from cert file /root/.omni/seethara.cert:
Traceback (most recent call last):
  File "/root/gcf-20100712/src/geni/omni/frameworks/framework_gcf.py",
line 49, in get_user_cred
    self.user_cred = self.ch.CreateUserCredential(self.cert_string)
...
  File "/usr/local/lib/python2.6/ssl.py", line 293, in do_handshake
    self._sslobj.do_handshake()
SSLError: [Errno 1] _ssl.c:480: error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca


Or similar 'do_handshake' error then you should check that you are using a 
consistent set of certificates at the CH and client (ie all gcf certificates 
and keys etc).

4) In general when things go wrong
- make sure your -r argument has exactly the ch-cert.pem 
files for all your CHs.
- supply the --debug argument to all programs
- ensure all machines can ping each other
- try manual telnet to the host/ip and port as shown (for Aggregate Managers
and Clearinghouses)
- verify your omni config lists right cert/keys in your chosen framework area
- ensure you are using the cert/key pair for a user generated by the 
Clearinghouse you are trying to reach

5) Peering with PlanetLab
If your GCF installation works but you have trouble doing ListResources
against a PlanetLab Aggregate Manager:
[root@localhost gcf-20100712]# src/omni.py --debug listresources
>>>> DEBUG:omni:Loading config file /root/.omni/omni_config
>>>> INFO:omni:Using control framework gcf
>>>> ERROR:omni:Failed to List Resources from
>>>> urn:publicid:IDN+plc:uw+authority+gcf (https://171.67.75.2:12348):
>>>> <Fault 108: ": ListResources: Insufficient rights: Access denied:
>>>> <class 'sfa.util.faults.GidParentHrn'>    --
>>>> u'geni.net:gpo:gcf+authority+ch'">

This is likely an indication of out-of-date PlanetLab code.
Update your SFA installation and restart.

If your error looks like this:
root@localhost gcf-20100712]# src/omni.py --debug listresources
DEBUG:omni:Loading config file /root/.omni/omni_config
INFO:omni:Using control framework gcf
ERROR:omni:Failed to List Resources from
urn:publicid:IDN+plc:uw+authority+gcf (https://171.67.75.2:12348):
<Fault 108: ': ListResources: Insufficient rights: Access denied:
<class \'sfa.util.faults.CredentialNotVerifiable\'> -- \'xmlsec1 error
verifying cert:
func=xmlSecCryptoDLLibraryCreate:file=dl.c:line=130:obj=xmlsec_lt_dlopen:subj=unknown:error=7:io
function failed:filename=libxmlsec1-openssl.so\\nfunc=xmlSecCryptoDLGetLibraryFunctions:file=dl.c:line=453:obj=unknown:subj=xmlSecCryptoDLLibraryCreate:error=1:xmlsec
library function
failed:crypto=openssl\\nfunc=xmlSecCryptoDLLoadLibrary:file=dl.c:line=404:obj=unknown:subj=xmlSecCryptoDLGetLibraryFunctions:error=1:xmlsec
library function failed: \\nError: unable to load xmlsec-openssl
library. Make sure that you have\\nthis it installed, check shared
libraries path (LD_LIBRARY_PATH)\\nenvornment variable or use
"--crypto" option to specify different\\ncrypto engine.

This indicates that you are missing 2 packages:
install xmlsec1-openssl-devel and xmlsec1

Finally make sure that your GCF-CH includes in its trusted_certs (-r argument) 
the relevant CH certificate(s).

6) Running across machines
Anytime you run across machines (Clearinghouse and Aggregate Manager on different machines)
you may run in to this:
You programmatically (eg via Omni) get a Slice credential from your Clearinghouse
and then use it to call ListResources on an Aggregate Manager:

>>> am.ListResources([cred], {})
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/lib/python2.6/xmlrpclib.py", line 1199, in __call__
    return self.__send(self.__name, args)
  File "/usr/lib/python2.6/xmlrpclib.py", line 1489, in __request
    verbose=self.__verbose
  File "/usr/lib/python2.6/xmlrpclib.py", line 1253, in request
    return self._parse_response(h.getfile(), sock)
  File "/usr/lib/python2.6/xmlrpclib.py", line 1392, in _parse_response
    return u.close()
  File "/usr/lib/python2.6/xmlrpclib.py", line 838, in close
    raise Fault(**self._stack[0])
xmlrpclib.Fault: <Fault 108: ": ListResources: Insufficient rights: Access denied: <class 'sfa.util.faults.CredentialNotVerifiable'> -- 'xmlsec1 error verifying cert: func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=360:obj=x509-store:subj=X509_verify_cert:error=4:crypto library function failed:subj=/CN=expedient:stanford+authority+ca;err=9;msg=certificate is not yet valid\\nfunc=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=391:obj=x509-store:subj=unknown:error=75:certificate is not yet valid:err=9;msg=certificate is not yet valid\\nOK\\nSignedInfo References (ok/all): 1/1\\nManifests References (ok/all): 0/0\\n'">

If you look carefully at the reported Fault at the end it tells you that 'certificate is
not yet valid'. 
This indicates there may be a time synchronization problem: The Clearinghouse clock is behind 
the Aggregate Manager machine's clock.
Retrying with the same credentials later may work. Or synchronize the clocks if you have control
over them.

7) Expired credentials:
By default, GENI sample Clearinghouse slices last only 3600 seconds, per
the setting SLICE_CRED_LIFE. To actually use allocated resources,
you will likely want to extend that. The symptom of this problem is error text like:
Failed to retrieve status of
urn:publicid:IDN+openflow:bbn+authority+ch+slice+slicename at
urn:publicid:IDN+openflow:bbn+authority+am
DEBUG:omni:<Fault Insufficient privileges: "No credential was found
with appropriate privileges. Tried
urn:publicid:IDN+openflow:bbn+user+experimenter. Last failure:
Couldn't validate cert urn:publicid:IDN+openflow:bbn+user+experimenter
with known root certs: 'Credential expired at 2010-07-16T00:26:16'"> 

